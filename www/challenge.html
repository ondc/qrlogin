<html>
<head>
<title>QR Login</title>
<link rel="stylesheet" href="mobile_styles.css" type="text/css" />
<script src="qrcode.js" type="text/javascript"></script>
<script src="bitcoinjs-min.js" type="text/javascript"></script>
<script src="bitcoinsig.js" type="text/javascript"></script>
<script src="secure-random.js" type="text/javascript"></script>
<script src="libs.js" type="text/javascript"></script>
<script src="mobileapp.js" type="text/javascript"></script>
<meta name="viewport" content="width=320">
</head>

<body onload="startSign()">
<div class="header">
<img src="img/qrlogo-sw.png" class="logo"/>
<div class="serviceid"><span id="serviceId"></span></div>
</div>

<div class="password" id="password_form">
<label><span id="enter_password">Enter password (optional)</span>
<input type="password" class="password" id="password_input" />
</label>
<label><input type="checkbox" id="always_blank" /><span id="keep_password_blank">Always blank</span></label>
</div>
<div class="accept"><button id="accept_button" />Login</button></div>
<div class="create"><button id="create_button" />Create profile</button></div>
<div class="spinner" id="spinner"><img src="img/spinner.gif"></div>


<script type="text/javascript">
 




var args = location.hash.substr(1).split(',');
var lang = args[0];
var host = args[1];
var c = args[2];


function combineKeyAndPin(key,pin) {
	var keypin = key + pin;
	return Crypto.SHA256(keypin, {asBytes:true});
}

function signRequest(c,key) {
	return sign_message(new Bitcoin.ECKey(key),c,false);
}

function run() {
	
	var hostitem =  document.getElementById("host");
	var serviceId = document.getElementById("serviceId");
	langSetText(hostitem,"host");
	serviceId.appendChild(document.createTextNode(host));

	setTimeout(run2,1);	
} 

if (!Date.now) {
    Date.now = function() { return new Date().getTime(); }
}

function run2() 			
{ //some browsers fails to update UI if there is no small delay before following action
	
	var keystore = localStorage["secretKey"]?JSON.parse(localStorage["secretKey"]):{}
	
	
	if (keystore[host]) {
			
		var keyinfo = keystore[host];
		if (keyinfo.hasPwd) {
			
			var pin = prompt(langtab["enter_password"]);			
			key = combineKeyAndPin(keyinfo.secret,pin);
			
		} else {
			key = combineKeyAndPin(keyinfo.secret);
		}
			
		document.getElementById("progress").innerHTML=langtab["sending_response"];
		var timestamp = Math.floor(Date.now() / 1000);
		var msg = "login to "+host+", challenge is "+c+", timestamp "+ timestamp;
		var signature = signRequest(msg,key);
//		if (window.console) console.log("Message: '"+msg + "' signature '" + signature + "'");
		
		location.href="r?c=" + c + "&r=" + encodeURIComponent(signature) + "&t="+timestamp+"#" + lang;
		//console.log("r?c=" + c + "&r=" + encodeURIComponent(signature) + "#" + lang);
		
	} else {
		
		if (confirm(langtab["confirm_new_identity"])) {
						
			var bytes = secureRandom(32);
			keystore[host] = {
					secret:Crypto.util.bytesToHex(bytes)+c,
					hasPwd:confirm(langtab["do_you_want_protect"])
			}
			keystore._dirty = true;
			localStorage["secretKey"] = JSON.stringify(keystore);
			run2();						
		} else {
			var restorebackup = document.getElementById("restorebackup");
			var backupfile = document.getElementById("backupfile");
			backupfile.addEventListener("change",function() {
				if (backupfile.files.length == 1) {
					var reader = new FileReader();
					reader.onload = function(evt) {
						var json = JSON.parse(evt.target.result);
						if (keystore) {
							for (var k in json) {
								if (!(keystore.hasOwnProperty(k))) keystore[k] = json[k];
							}
						} else {
							keystore = json;
						}
						localStorage["secretKey"] = JSON.stringify(keystore);
						run2();
					};
					reader.readAsText(backupfile.files[0]);
				}
			});
			restorebackup.insertBefore(document.createTextNode(langtab["restore_backup"]),restorebackup.firstChild);
			restorebackup.style.visibility="visible";
		}
		
	}
}
	
function start() {
	loadLang(lang,function() {
		if (featureTest()) {
			run();
		}		
	});
}	

</script>


</body>

</html>