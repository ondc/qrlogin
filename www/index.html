<!DOCTYPE html>
<html>
<head>
<title>QR Login</title>
<link rel="stylesheet" href="index.css" type="text/css" />
<script type="text/javascript" src="libs.js"></script>
</head>
<body>
<h1><img src="img/small_logo.png">QR Login</h1>
<ul class="menu">
<li><a href="#whatis">What is QR Login</a></li>
<li><a href="#howork">How does it work?</a></li>
<li><a href="#testit">Test it now!</a></li>
<li><a href="#addsite">Add to your site</a></li>
<li><a href="#sourcecode">Source code</a></li>
<li><a href="#author">About the author</a></li>
</ul>
<div class="content">
<div class="page" id="whatis">
<h2>What is QR Login</h2>
<img src="img/qrlogin.png">
<h3>Features</h3>
<ul>
<li><strong>No extra app needed</strong> - just QR Scanner and standard browser
<li><strong>Fast and Easy</strong> - scan QR code and you are logged in. 
<li><strong>Privacy</strong> - different identity for each site
<li><strong>Security</strong> - uses ECDSA to transfer your identity
<li><strong>Easy integration</strong> - OAuth 2.0 protocol
<li><strong>Open source</strong> - <a href="#sourcecode">Sources are available</a> 
 




</ul>
</div>
<div class="page" id="howork">
<h2>How does it work?</h2>
<img src="img/howitworks.png">
</div>
<div class="page" id="testit">
<h2>Test it now!</h2>
<div class="testwindow">
<button id="testbutton" onclick="doTest();">Click button to uncover your ID on this site</button>
<p>Your ID will appear below</p>
<div class="waitanim" id="waitanim"><div></div></div>
<input id="IDtarget" type="text">

</div>
</div>
<div class="page" id="addsite">
<h2>Add to your site</h2>
<h3>Using OAuth 2.0</h3>
<dl>
<dt>Authorization endpoint:</dt>
<dd><strong><span class="putorigin"></span>auth</strong> (redirect)</dd>
<dt>Token endpoint:</dt>
<dd><strong><span class="putorigin"></span>token</strong> (POST)</dd>
<dt>Identity endpoint:</dt>
<dd><strong><span class="putorigin"></span>ident</strong> (GET, Authorization: Bearer)</dd>
<dt>Client identification:</dt>
<dd>The <strong>client_secret</strong> is ignored. The <strong>client_id</strong> must be equal to redirect_uri's  domain (including port if specified). The <strong>scope</strong> is ignored </dd>
<dt>Interface language:</dt>
<dd>Include <strong>&lang=XX</strong> into the <em>Authorization endpoint</em> url. Currently supported languages are: en, cs
</dl>
<hr>
<a href="#addsite" onclick="uncoverDetails(this,'addsitedetail');return false;" id="hidedetail">More &gt;&gt; </a>
<div id="addsitedetail">
<a href="#addsite" onclick="uncoverDetails(this.parentElement,'hidedetail');return false;" >Less &lt;&lt;</a>
<ol>
<li>Redirect the user-agent to the "auth" page:<pre>
	<strong><span class="putorigin"></span>auth?redirect_uri=&lt;url&gt;&amp;state=&lt;state&gt;</strong>
	</pre>
<ul>
<li><strong>url</strong> - url of a page to redirect the user-agent after the autentification.
<li><strong>state</strong> - CSRF token (a random string generated by your site)
<li>After redirection, read the <strong>code</strong> and check the <strong>state</strong>
</ul>
<li>Receive the identity - let your site validates the returned token<pre>
	POST <strong><span class="putorigin"></span>token</strong>
	DATA code=&lt;code&gt;&amp;client_id=&lt;domain&gt;
	</pre>
<ul>
<li><strong>code</strong> - the string retrieved from the previous step
<li><strong>domain</strong> - whole domain name (including the port, if specified) must match the domain name of the redirect_uri
<li>The response should look like:<pre>
	{
	"access_token":"xxxxx...xxxx",
	 "expires_in":3600,
	 "identity":"yyyy...yyyy",
	 "token_type":"Bearer"
	 }
</pre>
where <strong>idenity</strong> is unique idenity string for the autentificated user.
</li>
<li><strong>NOTE:</strong> This request invalidates the "code". If you need to retrieve the identity
 later, use the <strong>access_token</strong> in the following step.
</ul>
<li>(optional) Receive the identity with the access_token:<pre>
	GET <strong><span class="putorigin"></span>ident</strong>
	Autorization: Bearer <strong>&lt;access_token&gt;</strong> 
	</pre>
	<ul>
<li><strong>access_token</strong> - the token retrieved from the previous step</li>
<li>The response should look like:<pre>
	{
	 "identity":"yyyy...yyyy",
	 }
</pre>
where <strong>idenity</strong> is unique idenity string for the autentificated user.
</ul>
</ol>
</div>
</div>
<div class="page" id="sourcecode">
<h2>Sources available at:</h2>
<div class="sources" id="sources">
    <div><a href="https://github.com/ondra-novak/qrlogin" target="_blank"><img src="img/GitHub-Mark-120px-plus.png" /></a></div>
    <div><a href="https://github.com/ondra-novak/qrlogin" target="_blank">https://github.com/ondra-novak/qrlogin</a></div>
</div>
</div>
<div class="page" id="author">
<h2>About the author</h2>
<div class="author">
<div><img src="img/author.jpg"></div>
<div><h3>Ondřej Novák</h3>
	<ul>
	<li><b>Facebook: </b><a href="https://www.facebook.com/ondra.novacisko.cz">www.facebook.com/ondra.novacisko.cz</a>
	<li><b>Twitter: </b><a href="https://twitter.com/novacisko">@novacisko</a>
	<li><b>GitHub: </b><a href="https://github.com/ondra-novak">ondra-novak</a>
	<li><b>E-mail: </b>nov.ondrej@gmail.com</a>
	</ul>
</div>
</div>
</div>
</div>

<script type="text/javascript">

function doTest() {
	var redirUrl = location.origin+location.pathname+"?test=1"
	var qrloginUrl = location.origin+"/auth?redirect_uri="+encodeURIComponent(redirUrl);
	location.href=qrloginUrl;
	document.getElementById("waitanim").style.visibility="visible";
}

function processResponse(response) {
	var r = JSON.parse(response);
	var out = document.getElementById("IDtarget");
	out.value = r.identity;
}

function showError() {
	var out = document.getElementById("IDtarget");
	out.value = "Token is no longer valid";
}

function validateToken(token) {
	document.getElementById("waitanim").style.visibility="visible";
	var out = document.getElementById("IDtarget");
	out.value="";
	location.href = "#testit"
	if (window.history.pushState) window.history.pushState("", "", "/");
	var qrloginUrl = location.origin+"/token";
	var rq = new XMLHttpRequest();
	var client_id = location.host;
	rq.open("POST",qrloginUrl,true);
	var request="code="+encodeURIComponent(token)+"&client_id="+encodeURIComponent(client_id);
	rq.onreadystatechange = function(r) {
        if (rq.readyState == 4 ) {
        	document.getElementById("waitanim").style.visibility="hidden";
            if (rq.status == 200) {
                var response = rq.responseText;
                processResponse(response);
            } else if (rq.status == 400)  {
            	showError();
            } else {
            	alert("Ooops! Something wrong happened: error="+rq.status);
            }
        }
	}
	rq.send(request);		
}

if (!window.location.origin) {
    window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
}

function putUrl() {
	var items = document.getElementsByClassName("putorigin");
	for (var i = 0; i < items.length; i++) {
		var x = items[i];
		x.appendChild(document.createTextNode(location.origin+location.pathname));
	}
}

function uncoverDetails(tohide, toshow) {
	var toshowel = document.getElementById(toshow);
	tohide.style.display = "none";
	toshowel.style.display = "block";
}

var qs = getQueryString(location.search);
if (qs.test) validateToken(qs.code);
putUrl();


</script>
</body>
</html>

