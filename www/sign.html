<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio">
<TITLE></TITLE>
</HEAD>
<BODY>
    <script src="libs/qrlogin-crypto.js" type="text/javascript"></script>
    <script src="libs/common.js" type="text/javascript"></script>
    <p><label>Message:
    <textarea id="msgtosign" cols="80" rows="5"></textarea></label></p>
    <p>
        <label>Char count:<input type="text" id="charcount" readonly="readonly" /> (if >160, hash is used)</label>
    </p>
    <p>
        <label>Hash:<input type="text" id="msghash" readonly="readonly" size="80"/></label></p>

        <button id="dosign">Sign message</button>
    <hr />
    <p>
        <label>
            Signature:
            <textarea id="signature" cols="80" rows="5" readonly="readonly"></textarea>
        </label>
    </p>
    <p>
        <label>Identity:<input type="text" id="identity" readonly="readonly" size="80"/></label>
    </p>
    <div style="position:absolute;right:0; top:0;width:450px;height:640px;background-color:white" id="qrbox">
    <iframe width="100%" height="100%" style="border:0" id="qriframe"></iframe>
    </div>


<script>
    if (!window.location.origin) {
        window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
    }


    var qrbox = getBlockById("qrbox");
    var qriframe = getBlockById("qriframe");
    var signature = getBlockById("signature");
    document.getElementById("msgtosign").addEventListener("input", function (e) {
        var s = new BitcoinSign;
        var msg = e.target.value.trim();
        document.getElementById("msghash").value = Crypto.util.bytesToHex(s.msg_digest(msg));
        document.getElementById("charcount").value = encodeURIComponentPlus(msg).length;
        qrbox.hide();
        signature.value = "";
            });
    qrbox.hide();
    document.getElementById("dosign"). addEventListener("click", function (e) {
        qrbox.show();
        var s = new BitcoinSign;
        var msg = document.getElementById("msgtosign").value.trim();
        var msghash = Crypto.util.bytesToHex(s.msg_digest(msg));
        msg = encodeURIComponentPlus(msg);
        var cmd=msg.length<160?"&signmsg="+msg:"&signhash="+msghash;
        qriframe.src = "auth#?redirect_uri="+document.location.origin+document.location.pathname+"&js=true" + cmd;
    });
    window.addEventListener("hashchange", function () {
        if (location.hash.substr(0, 7) == "#?code=") {
            var query = location.hash.substr(1);
            var qs = getQueryString(query);;
            var res = QRlogin_decodeMsgSignature(qs.code);
            var sign = document.getElementById("signature");
            var ident = document.getElementById("identity");
            sign.value = res[0];
            ident.value = res[1];
            qrbox.hide();
        }
    })

</script>
</BODY>
</HTML>
